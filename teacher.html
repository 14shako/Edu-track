<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTrack - Teacher Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; }
        aside { 
    backdrop-filter: blur(12px); 
    background-color: rgba(15, 23, 42, 0.9) !important; 
    transition: width 0.3s ease; /* Плавное сужение меню */
}

/* Это скроет заголовок EduTrack на мобилках, чтобы не мешался */
@media (max-width: 768px) {
    aside h2 { display: none; } 
    .lang-btn span { display: none; } /* Скроет текст RU/EN/AZ, оставит только иконки если они есть */
    aside { padding-left: 0 !important; padding-right: 0 !important; align-items: center; }
}
        .online-dot { position: absolute; top: 20px; right: 20px; width: 10px; height: 10px; background: #10b981; border-radius: 50%; z-index: 10; }
        .online-dot::after { content: ''; position: absolute; width: 100%; height: 100%; background: #10b981; border-radius: 50%; animation: pulse 2s infinite; opacity: 0.5; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(3); opacity: 0; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .tab-section { display: none; }
        .tab-section.active { display: block; animation: fadeIn 0.4s ease forwards; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .nav-link.active { background-color: #2563eb; color: white; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.2); }
        .lang-btn.active { color: #3b82f6 !important; border-bottom: 2px solid #3b82f6; }
        .standard-card { background: white; padding: 2rem; border-radius: 35px; border: 2px solid #f1f5f9; transition: all 0.3s ease; display: flex; flex-direction: column; height: 100%; position: relative; }
        .standard-card:hover { transform: translateY(-5px); border-color: #2563eb; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05); }
        .att-table th { @apply p-4 text-left text-[10px] font-black uppercase text-slate-400 tracking-wider; }
        .att-table td { @apply p-4 border-t border-slate-50 font-bold text-slate-700; }
@media (max-width: 768px) {
    .nav-link { justify-content: center; }
    header h1 { font-size: 1.5rem !important; }
    .standard-card { padding: 1rem !important; }
    aside .mb-10 h2, aside .lang-btn span { display: none; }
}
    </style>
</head>
<body class="flex min-h-screen">

<aside class="w-20 md:w-64 fixed h-full p-3 md:p-6 text-white flex flex-col shadow-2xl z-50">
        <div class="text-2xl font-black mb-10 text-blue-500 italic tracking-tighter">EDUTRACK</div>
        <nav class="flex-1 space-y-3">
<button onclick="tab('my-st')" id="nav-my-st" class="nav-link active w-full text-left p-4 rounded-2xl font-bold transition-all">
                <i class="fa-solid fa-star mr-2"></i> 
                <span class="hidden md:inline" data-i18n="menu-my">Мои ученики</span>
            </button>
            <button onclick="tab('att')" id="nav-att" class="nav-link w-full text-left p-4 rounded-2xl font-bold transition-all">
                <i class="fa-solid fa-calendar-check mr-2"></i> 
                <span class="hidden md:inline" data-i18n="menu-att">Посещаемость</span>
            </button>
            <button onclick="tab('all-st')" id="nav-all-st" class="nav-link w-full text-left p-4 rounded-2xl font-bold transition-all">
                <i class="fa-solid fa-users mr-2"></i> 
                <span class="hidden md:inline" data-i18n="menu-all">Все ученики</span>
            </button>
            <button onclick="tab('tc')" id="nav-tc" class="nav-link w-full text-left p-4 rounded-2xl font-bold transition-all">
                <i class="fa-solid fa-chalkboard-user mr-2"></i> 
                <span class="hidden md:inline" data-i18n="menu-tc">Коллеги</span>
            </button>
            <button onclick="tab('pr')" id="nav-pr" class="nav-link w-full text-left p-4 rounded-2xl font-bold transition-all">
                <i class="fa-solid fa-user mr-2"></i> 
                <span class="hidden md:inline" data-i18n="menu-pr">Профиль</span>
            </button>
        
        <div class="flex gap-2 justify-center mb-6 bg-white/5 p-2 rounded-xl">
            <button onclick="setLang('RU')" id="lang-RU" class="lang-btn active p-2 text-xs font-bold text-white/50">RU</button>
            <button onclick="setLang('EN')" id="lang-EN" class="lang-btn p-2 text-xs font-bold text-white/50">EN</button>
            <button onclick="setLang('AZ')" id="lang-AZ" class="lang-btn p-2 text-xs font-bold text-white/50">AZ</button>
        </div>
        
        <button onclick="logout()" class="p-3 text-red-400 font-bold mt-auto hover:text-red-300 transition-colors"><i class="fa-solid fa-power-off mr-2"></i> <span data-i18n="logout">Выйти</span></button>
    </aside>

<main class="flex-1 ml-20 md:ml-64 p-4 md:p-10 transition-all">
        <header class="mb-12">
            <h1 id="teacher-display-name-main" class="text-4xl font-black text-slate-800 tracking-tight mb-8 uppercase italic">Кабинет учителя</h1>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-6 rounded-[30px] border-b-4 border-blue-600 shadow-sm flex items-center justify-between">
                    <div><p class="text-[10px] font-black uppercase text-slate-400" data-i18n="count-st-label">Студентов</p><h3 id="count-st" class="text-3xl font-black text-slate-800">0</h3></div>
                    <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center text-xl"><i class="fa-solid fa-user-graduate"></i></div>
                </div>
                <div class="bg-white p-6 rounded-[30px] border-b-4 border-slate-900 shadow-sm flex items-center justify-between">
                    <div><p class="text-[10px] font-black uppercase text-slate-400" data-i18n="count-tc-label">Учителей</p><h3 id="count-tc" class="text-3xl font-black text-slate-800">0</h3></div>
                    <div class="w-12 h-12 bg-slate-100 text-slate-600 rounded-2xl flex items-center justify-center text-xl"><i class="fa-solid fa-apple-whole"></i></div>
                </div>
                <div class="bg-white p-6 rounded-[30px] border-b-4 border-blue-600 shadow-sm flex items-center justify-between">
                    <div><p class="text-[10px] font-black uppercase text-slate-400" data-i18n="count-my-label">Ваши ученики</p><h3 id="count-my" class="text-3xl font-black text-blue-600">0</h3></div>
                    <div class="w-12 h-12 bg-blue-600 text-white rounded-2xl flex items-center justify-center text-xl"><i class="fa-solid fa-heart"></i></div>
                </div>
            </div>
        </header>

        <div id="sec-att" class="tab-section">
            <div class="bg-white p-8 rounded-[40px] shadow-sm border border-slate-100 mb-8">
                <h2 class="text-2xl font-black text-slate-800 mb-6 uppercase italic" data-i18n="menu-att">Журнал посещаемости</h2>
                <div class="flex flex-wrap gap-4 mb-8">
                    <div class="flex-1 min-w-[200px]">
                        <label class="text-[10px] font-black text-slate-400 ml-2 uppercase" data-i18n="label-sel-st">Выберите ученика</label>
                        <select id="att-select-student" class="w-full mt-1 p-4 bg-slate-50 rounded-2xl font-bold border-2 border-transparent focus:border-blue-600 outline-none transition-all">
                            <option value="" data-i18n="opt-st-list">-- Список учеников --</option>
                        </select>
                    </div>
                    <div class="flex-1 min-w-[200px]">
                        <label class="text-[10px] font-black text-slate-400 ml-2 uppercase" data-i18n="label-status">Статус</label>
                        <select id="att-status" onchange="toggleLateField()" class="w-full mt-1 p-4 bg-slate-50 rounded-2xl font-bold border-2 border-transparent focus:border-blue-600 outline-none">
                            <option value="present" data-i18n="st-present">Пришёл</option>
                            <option value="absent" data-i18n="st-absent">Не пришёл</option>
                            <option value="late" data-i18n="st-late">Опоздал</option>
                            <option value="transferred" data-i18n="st-trans">Переведён на другой день</option>
                        </select>
                    </div>
                    
                    <div id="late-minutes-box" class="hidden">
                        <label class="text-[10px] font-black text-slate-400 ml-2 uppercase" data-i18n="label-mins">Минуты</label>
                        <input type="number" id="att-late-min" placeholder="Мин" class="w-24 mt-1 p-4 bg-slate-50 rounded-2xl font-bold border-2 border-transparent focus:border-blue-600 outline-none">
                    </div>

                    <div id="transfer-date-box" class="hidden flex-1 min-w-[200px]">
                        <label class="text-[10px] font-black text-slate-400 ml-2 uppercase" data-i18n="label-trans-date">Дата переноса</label>
                        <input type="date" id="att-transfer-date" class="w-full mt-1 p-4 bg-slate-50 rounded-2xl font-bold border-2 border-transparent focus:border-blue-600 outline-none">
                    </div>

                    <div class="flex items-end">
                        <button onclick="saveAttendance()" class="bg-blue-600 text-white h-[60px] px-8 rounded-2xl font-black uppercase text-xs hover:bg-blue-700 transition-all shadow-lg shadow-blue-200" data-i18n="btn-mark">Отметить</button>
                    </div>
                </div>

<div class="overflow-x-auto rounded-3xl border border-slate-100 bg-white">
    <table class="w-full min-w-[600px] att-table">
                        <thead class="bg-slate-50">
                            <tr>
                                <th data-i18n="th-date">Дата записи</th>
                                <th data-i18n="th-status">Статус</th>
                                <th data-i18n="th-details">Подробности</th>
                            </tr>
                        </thead>
                        <tbody id="att-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="sec-my-st" class="tab-section active">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black text-slate-800 uppercase italic" data-i18n="menu-my">Мои ученики</h2>
                <div class="flex gap-4">
                    <button onclick="openAddModal()" class="bg-slate-200 text-slate-700 px-6 py-4 rounded-2xl font-black uppercase text-xs" data-i18n="btn-link">Привязать</button>
                    <button onclick="openCreateModal()" class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-black shadow-xl uppercase text-xs" data-i18n="btn-create-new">+ Создать</button>
                </div>
            </div>
            <div id="my-st-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-8"></div>
        </div>

        <div id="sec-all-st" class="tab-section">
            <h2 class="text-2xl font-black text-slate-800 mb-8 uppercase italic" data-i18n="menu-all">Все ученики</h2>
            <div id="all-st-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </div>

        <div id="sec-tc" class="tab-section">
            <h2 class="text-2xl font-black text-slate-800 mb-8 uppercase italic" data-i18n="menu-tc">Коллеги</h2>
            <div id="tc-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </div>

        <div id="sec-pr" class="tab-section">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-6xl mx-auto">
                <div class="bg-white p-10 rounded-[40px] shadow-sm border-2 border-slate-50">
                    <div class="flex items-center gap-6 mb-10">
                        <div class="relative">
                            <img id="prof-img" src="https://ui-avatars.com/api/?name=T&background=2563eb&color=fff" class="w-24 h-24 object-cover rounded-[30px] border-4 border-white shadow-md">
                            <label class="absolute -bottom-2 -right-2 bg-slate-900 text-white p-2 rounded-xl cursor-pointer hover:bg-blue-600 transition-colors"><i class="fa-solid fa-camera text-xs"></i><input type="file" id="avatar-input" class="hidden" accept="image/*" onchange="previewImage(this)"></label>
                        </div>
                        <div>
                            <p class="text-[10px] font-black text-blue-600 uppercase tracking-widest mb-1" data-i18n="role-tc">Учитель</p>
                            <h3 id="display-name-profile" class="text-2xl font-black text-slate-800">---</h3>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div><label class="text-[10px] font-black text-slate-400 ml-2 uppercase" data-i18n="field-name">Имя Фамилия</label><input type="text" id="edit-name" class="w-full mt-1 p-4 bg-slate-50 rounded-2xl font-bold border-2 border-transparent focus:border-blue-600 outline-none"></div>
                        <div><label class="text-[10px] font-black text-slate-400 ml-2 uppercase" data-i18n="field-phone">Телефон</label><div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 font-black text-slate-400">+994</span><input type="text" id="edit-phone" maxlength="9" class="w-full p-4 pl-16 bg-slate-50 rounded-2xl font-bold border-2 border-transparent focus:border-blue-600 outline-none"></div></div>
                        <div><label class="text-[10px] font-black text-slate-400 ml-2 uppercase">Zoom Link</label><input type="url" id="edit-zoom" placeholder="https://zoom.us/j/..." class="w-full mt-1 p-4 bg-slate-50 rounded-2xl font-bold border-2 border-transparent focus:border-blue-600 outline-none"></div>
                        
                        <button onclick="saveProfile()" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-blue-600 transition-all shadow-xl" data-i18n="btn-save">Обновить</button>
                    </div>
                </div>
                
                <div class="flex flex-col gap-6">
                    <div class="bg-white p-10 rounded-[40px] shadow-sm border-2 border-slate-50">
                        <div>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2" data-i18n="acc-status">Статус аккаунта</p>
                            <div class="flex gap-1 mb-10"><div class="h-1.5 w-10 bg-blue-600 rounded-full"></div><div class="h-1.5 w-10 bg-blue-600 rounded-full"></div><div class="h-1.5 w-10 bg-slate-200 rounded-full"></div></div>
                            <div class="bg-slate-50 p-8 rounded-[35px] border border-slate-100">
                                <p class="text-[10px] font-black text-slate-400 uppercase mb-4" data-i18n="count-my-label">Ваши ученики</p>
                                <div class="flex items-center gap-4"><h4 id="count-my-profile" class="text-5xl font-black text-slate-800">0</h4><div class="text-blue-600 text-2xl"><i class="fa-solid fa-graduation-cap"></i></div></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-8 rounded-[40px] shadow-sm border-2 border-slate-50">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4" data-i18n="label-subject">Ваш предмет</p>
                        <select id="edit-subject" class="w-full p-4 bg-slate-50 border-2 border-transparent focus:border-blue-600 rounded-2xl font-bold text-slate-700 outline-none">
                            <option value="" data-i18n="opt-sub">Выберите урок</option>
                            <option value="English">Английский</option>
                            <option value="Math">Математика</option>
                            <option value="Programming">Программирование</option>
                            <option value="Art">Рисование</option>
                            <option value="Physics">Физика</option>
                        </select>
                    </div>

                    <div class="bg-white p-8 rounded-[40px] shadow-sm border-2 border-slate-50">
                        <p class="text-[10px] font-black text-slate-300 uppercase mb-1">Email</p>
                        <p id="u-email" class="font-bold text-slate-400 italic text-sm">---</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="addModal" class="modal">
        <div class="bg-white w-full max-w-md rounded-[40px] p-8 shadow-2xl">
            <h2 class="text-2xl font-black mb-6 uppercase italic text-slate-800" data-i18n="modal-select-title">Выбрать ученика</h2>
            <div id="available-st-list" class="space-y-3 max-h-80 overflow-y-auto mb-6 pr-2"></div>
            <button onclick="closeModal('addModal')" class="w-full py-4 bg-slate-100 text-slate-500 rounded-2xl font-black uppercase text-xs" data-i18n="btn-cancel">Закрыть</button>
        </div>
    </div>

    <div id="createStudentModal" class="modal">
        <div class="bg-white p-10 rounded-[40px] shadow-2xl w-full max-w-md border-t-[10px] border-blue-600 overflow-y-auto max-h-[90vh]">
            <h2 class="text-2xl font-black mb-6 text-slate-800 italic uppercase" data-i18n="modal-create-title">Новый ученик</h2>
            <div class="space-y-4">
                <input type="text" id="new-st-name" data-placeholder="ph-name" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none font-bold">
                <input type="email" id="new-st-email" placeholder="Email" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none font-bold">
                <input type="password" id="new-st-pass" data-placeholder="ph-pass" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none font-bold">
                
                <div class="relative">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 font-black text-slate-400">+994</span>
                    <input type="text" id="new-st-phone" maxlength="9" class="w-full p-4 pl-16 bg-slate-50 border rounded-2xl outline-none font-bold">
                </div>

                <select id="new-st-lvl" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none font-bold text-slate-500">
                    <option value="" disabled selected data-i18n="opt-lvl">Выберите уровень (LVL)</option>
                    <option value="A1">A1 - Beginner</option>
                    <option value="A2">A2 - Elementary</option>
                    <option value="B1">B1 - Intermediate</option>
                    <option value="B2">B2 - Upper-Intermediate</option>
                    <option value="C1">C1 - Advanced</option>
                </select>

                <select id="new-st-subject" class="w-full p-4 bg-slate-50 border rounded-2xl outline-none font-bold text-slate-500">
                    <option value="" disabled selected data-i18n="opt-sub">Выберите урок</option>
                    <option value="English">Английский</option>
                    <option value="Math">Математика</option>
                    <option value="Programming">Программирование</option>
                    <option value="Art">Рисование</option>
                </select>

                <button onclick="createStudent()" id="btn-create-st" class="w-full bg-slate-900 text-white py-5 rounded-3xl font-black uppercase tracking-widest hover:bg-blue-600 transition-all shadow-lg" data-i18n="btn-create-submit">Создать и привязать</button>
                <button onclick="closeModal('createStudentModal')" class="w-full text-slate-400 font-bold mt-2" data-i18n="btn-cancel">Отмена</button>
            </div>
        </div>
    </div>

    <script>
        const _supabase = supabase.createClient("https://jjeiytzftlmvpweaglvz.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqZWl5dHpmdGxtdnB3ZWFnbHZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0ODY5OTAsImV4cCI6MjA4NjA2Mjk5MH0.kvUjwknKvHG6Xp7xg9w7oM8kn2AaggdxxhHvTsjatJI");
        let tid = null;

        const i18n = {
            RU: { 
                "menu-my": "Мои ученики", "menu-att": "Посещаемость", "menu-all": "Все ученики", "menu-tc": "Коллеги", "menu-pr": "Профиль", 
                "logout": "Выйти", "count-st-label": "Студентов", "count-tc-label": "Учителей", "count-my-label": "Ваши ученики", 
                "btn-link": "Привязать", "btn-save": "Обновить", "no-phone": "Нет номера", "btn-hw": "Задать ДЗ", 
                "role-tc": "Учитель", "role-st": "Ученик", "field-name": "Имя Фамилия", "field-phone": "Телефон",
                "btn-create-new": "+ Создать", "modal-create-title": "Новый ученик", "modal-select-title": "Выбрать ученика",
                "ph-name": "Имя Фамилия", "ph-pass": "Пароль", "ph-phone": "Номер (50...)", 
                "opt-lvl": "Выберите уровень", "opt-sub": "Выберите урок", "btn-create-submit": "Создать и привязать", "btn-cancel": "Отмена",
                "label-subject": "Ваш предмет", "acc-status": "Статус аккаунта", "cabinet-title": "Кабинет учителя",
                "label-sel-st": "Выберите ученика", "opt-st-list": "-- Список учеников --", "label-status": "Статус",
                "st-present": "Пришёл", "st-absent": "Не пришёл", "st-late": "Опоздал", "st-trans": "Переведён",
                "label-mins": "Минуты", "label-trans-date": "Дата переноса", "btn-mark": "Отметить",
                "th-date": "Дата записи", "th-status": "Статус", "th-details": "Подробности", "no-records": "Нет записей"
            },
            EN: { 
                "menu-my": "My Students", "menu-att": "Attendance", "menu-all": "All Students", "menu-tc": "Colleagues", "menu-pr": "Profile", 
                "logout": "Logout", "count-st-label": "Students", "count-tc-label": "Teachers", "count-my-label": "Your Students", 
                "btn-link": "Connect", "btn-save": "Update", "no-phone": "No phone", "btn-hw": "Assign HW", 
                "role-tc": "Teacher", "role-st": "Student", "field-name": "Full Name", "field-phone": "Phone",
                "btn-create-new": "+ Create", "modal-create-title": "New Student", "modal-select-title": "Select Student",
                "ph-name": "Full Name", "ph-pass": "Password", "ph-phone": "Phone (50...)", 
                "opt-lvl": "Select Level", "opt-sub": "Select Subject", "btn-create-submit": "Create & Link", "btn-cancel": "Cancel",
                "label-subject": "Your Subject", "acc-status": "Account Status", "cabinet-title": "Teacher Cabinet",
                "label-sel-st": "Select student", "opt-st-list": "-- Student List --", "label-status": "Status",
                "st-present": "Present", "st-absent": "Absent", "st-late": "Late", "st-trans": "Transferred",
                "label-mins": "Minutes", "label-trans-date": "Transfer Date", "btn-mark": "Mark",
                "th-date": "Date", "th-status": "Status", "th-details": "Details", "no-records": "No records found"
            },
            AZ: { 
                "menu-my": "Tələbələrim", "menu-att": "Davamiyyət", "menu-all": "Bütün tələbələr", "menu-tc": "Həmkarlar", "menu-pr": "Profil", 
                "logout": "Çıxış", "count-st-label": "Tələbələr", "count-tc-label": "Müəllimlər", "count-my-label": "Şagirdləriniz", 
                "btn-link": "Bağla", "btn-save": "Yenilə", "no-phone": "Nömrə yoxdur", "btn-hw": "Tapşırıq ver", 
                "role-tc": "Müəllim", "role-st": "Şagird", "field-name": "Ad Soyad", "field-phone": "Telefon",
                "btn-create-new": "+ Yarat", "modal-create-title": "Yeni Şagird", "modal-select-title": "Şagird seçin",
                "ph-name": "Ad Soyad", "ph-pass": "Şifrə", "ph-phone": "Nömrə (50...)", 
                "opt-lvl": "Səviyyəni seçin", "opt-sub": "Dərsi seçin", "btn-create-submit": "Yarat və Bağla", "btn-cancel": "Ləğv et",
                "label-subject": "Sizin fənniniz", "acc-status": "Hesab statusu", "cabinet-title": "Müəllim Kabineti",
                "label-sel-st": "Şagird seçin", "opt-st-list": "-- Şagird siyahısı --", "label-status": "Status",
                "st-present": "Gəldi", "st-absent": "Gəlmədi", "st-late": "Gecikdi", "st-trans": "Köçürüldü",
                "label-mins": "Dəqiqə", "label-trans-date": "Köçürülmə tarixi", "btn-mark": "Qeyd et",
                "th-date": "Tarix", "th-status": "Status", "th-details": "Təfərrüatlar", "no-records": "Qeyd tapılmadı"
            }
        };

        async function init() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (!user) { window.location.href="index.html"; return; }
            tid = user.id;

            _supabase.channel('profiles_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, () => loadData())
                .subscribe();

            const { data: p } = await _supabase.from('profiles').select('*').eq('id', tid).single();
            if(p) { 
                document.getElementById('teacher-display-name-main').innerText = p.full_name || "Кабинет учителя";
                document.getElementById('display-name-profile').innerText = p.full_name || "Учитель";
                document.getElementById('edit-name').value = p.full_name || "";
                document.getElementById('u-email').innerText = p.username || "";
                document.getElementById('edit-zoom').value = p.zoom_link || "";
                document.getElementById('edit-subject').value = p.subject || "";
                if (p.phone) document.getElementById('edit-phone').value = p.phone.replace('+994', '').trim();
            }
            loadData();
            setLang('RU');
        }

        async function loadData() {
            const activeBtn = document.querySelector('.lang-btn.active');
            const l = activeBtn ? activeBtn.id.split('-')[1] : 'RU';
            const { data: users } = await _supabase.from('profiles').select('*');
            const { data: schedule } = await _supabase.from('schedule').select('*').eq('teacher_id', tid);
            const myIds = schedule ? schedule.map(s => s.student_id) : [];

            document.getElementById('count-st').innerText = users.filter(u => u.role === 'student').length;
            document.getElementById('count-tc').innerText = users.filter(u => u.role === 'teacher').length;
            document.getElementById('count-my').innerText = myIds.length;
            document.getElementById('count-my-profile').innerText = myIds.length;

            const myStudents = users.filter(u => myIds.includes(u.id));
            const attSelect = document.getElementById('att-select-student');
            const currentVal = attSelect.value;
            attSelect.innerHTML = `<option value="">${i18n[l]['opt-st-list']}</option>` + 
                myStudents.map(s => `<option value="${s.id}">${s.full_name}</option>`).join('');
            attSelect.value = currentVal;

            const render = (u, mode) => {
                const subjectBadge = (u.role === 'teacher' && u.subject) 
                    ? `<div class="inline-flex items-center gap-2 px-3 py-1.5 bg-blue-50 text-blue-700 rounded-xl text-[11px] font-black uppercase mb-4 border border-blue-100"><i class="fa-solid fa-book-open"></i>${u.subject}</div>` 
                    : '';
                return `
                <div class="standard-card">
                    <div class="online-dot"></div>
                    ${mode==='my' ? `<button onclick="unlink('${u.id}')" class="absolute top-6 right-6 text-slate-200 hover:text-red-500 transition-colors z-20"><i class="fa-solid fa-circle-xmark fa-2xl"></i></button>` : ''}
                    <div class="w-16 h-16 bg-slate-100 rounded-3xl mb-6 overflow-hidden">
                        ${u.avatar_url ? `<img src="${u.avatar_url}" class="w-full h-full object-cover">` : `<div class="flex items-center justify-center h-full text-2xl font-black">${u.full_name ? u.full_name[0] : '?'}</div>`}
                    </div>
                    <h4 class="font-black text-slate-800 text-xl mb-1">${u.full_name || '...'}</h4>
                    ${subjectBadge}
                    <p class="text-blue-600 font-bold text-sm mb-2 italic">${u.phone || i18n[l]['no-phone']}</p>
                    <p class="text-slate-400 text-[10px] mb-8 font-bold italic underline">${u.username}</p>
                    <div class="mt-auto">
                        ${mode==='my' ? `<button class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-[10px] uppercase transition-all hover:bg-blue-600">${i18n[l]['btn-hw']}</button>` : `<div class="w-full py-4 bg-slate-50 text-slate-300 rounded-2xl font-black text-[10px] text-center uppercase border">${u.role === 'teacher' ? i18n[l]['role-tc'] : i18n[l]['role-st']}</div>`}
                    </div>
                </div>`;
            };

            document.getElementById('my-st-list').innerHTML = myStudents.map(u => render(u, 'my')).join('');
            document.getElementById('all-st-list').innerHTML = users.filter(u => u.role === 'student').map(u => render(u, 'all')).join('');
            document.getElementById('tc-list').innerHTML = users.filter(u => u.role === 'teacher').map(u => render(u, 'tc')).join('');
        }

        // Посещаемость
        function toggleLateField() {
            const status = document.getElementById('att-status').value;
            document.getElementById('late-minutes-box').className = status === 'late' ? 'block' : 'hidden';
            document.getElementById('transfer-date-box').className = status === 'transferred' ? 'block' : 'hidden';
        }

        async function saveAttendance() {
            const sid = document.getElementById('att-select-student').value;
            const status = document.getElementById('att-status').value;
            const lateMin = document.getElementById('att-late-min').value;
            const transferDate = document.getElementById('att-transfer-date').value;
            
            if(!sid) return alert("Выберите ученика!");

            let detail = "";
            if(status === 'late') detail = lateMin ? `Опоздал на ${lateMin} мин.` : "Опоздал";
            else if(status === 'present') detail = "Был на уроке";
            else if(status === 'absent') detail = "Отсутствовал";
            else if(status === 'transferred') {
                if(!transferDate) return alert("Укажите дату переноса!");
                const formattedDate = new Date(transferDate).toLocaleDateString('ru-RU');
                detail = `Урок перенесен на ${formattedDate}`;
            }

            const { error } = await _supabase.from('attendance').insert([{
                teacher_id: tid,
                student_id: sid,
                status: status,
                details: detail,
                date: new Date().toISOString()
            }]);

            if(error) alert(error.message);
            else {
                alert("Статус сохранен!");
                document.getElementById('att-late-min').value = "";
                document.getElementById('att-transfer-date').value = "";
                loadAttendanceTable(sid);
            }
        }

   async function loadAttendanceTable(sid) {
    const { data } = await _supabase.from('attendance').select('*').eq('student_id', sid).order('date', { ascending: false });
    const tbody = document.getElementById('att-table-body');
    
    // Получаем текущий активный язык (RU, EN или AZ)
    const activeBtn = document.querySelector('.lang-btn.active');
    const l = activeBtn ? activeBtn.id.split('-')[1] : 'RU';
    
    tbody.innerHTML = data.map(row => {
        const date = new Date(row.date).toLocaleDateString();
        
        // Цвета для статусов (оставляем как было)
        let statusColor = "bg-green-100 text-green-700";
        if(row.status === 'absent') statusColor = "bg-red-100 text-red-700";
        if(row.status === 'late') statusColor = "bg-yellow-100 text-yellow-700";
        if(row.status === 'transferred') statusColor = "bg-orange-100 text-orange-700";

        // ЛОГИКА ПЕРЕВОДА ДЕТАЛЕЙ:
        let displayDetails = "";
        
        if (row.status === 'present') {
            displayDetails = i18n[l]['st-present']; // "Пришёл" / "Present"
        } 
        else if (row.status === 'absent') {
            displayDetails = i18n[l]['st-absent']; // "Не пришёл" / "Absent"
        } 
        else if (row.status === 'late') {
            // Пытаемся достать цифру минут из строки (если она там есть)
            const mins = row.details.replace(/\D/g, ""); 
            displayDetails = `${i18n[l]['st-late']} ${mins ? mins + ' ' + i18n[l]['label-mins'] : ''}`;
        } 
        else if (row.status === 'transferred') {
            // Пытаемся достать дату из строки
            const dateMatch = row.details.match(/\d{2}\.\d{2}\.\d{4}/);
            displayDetails = `${i18n[l]['st-trans']} ${dateMatch ? dateMatch[0] : ''}`;
        }

        return `<tr>
            <td class="p-4 font-bold text-sm">${date}</td>
            <td class="p-4">
                <span class="px-3 py-1 rounded-full text-[10px] font-black ${statusColor}">
                    ${i18n[l]['st-' + row.status] || row.status.toUpperCase()}
                </span>
            </td>
            <td class="p-4 text-sm font-medium text-slate-600">${displayDetails}</td>
        </tr>`;
    }).join('') || `<tr><td colspan="3" class="text-center text-slate-300 py-10">${i18n[l]['no-records']}</td></tr>`;
}

        document.getElementById('att-select-student').onchange = (e) => {
            if(e.target.value) loadAttendanceTable(e.target.value);
        };

        function tab(name) {
            document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById('sec-' + name).classList.add('active');
            document.getElementById('nav-' + name).classList.add('active');
        }

function setLang(l) {
    // ... твой старый код смены классов active ...

    // Добавь это в конец функции:
    const currentStudent = document.getElementById('att-select-student').value;
    if (currentStudent) {
        loadAttendanceTable(currentStudent);
    }
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('lang-' + l).classList.add('active');
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[l][key]) el.innerText = i18n[l][key];
            });
            document.querySelectorAll('[data-placeholder]').forEach(el => {
                const key = el.getAttribute('data-placeholder');
                if (i18n[l][key]) el.placeholder = i18n[l][key];
            });
            loadData();
        }

        async function logout() {
            await _supabase.auth.signOut();
            window.location.href = "index.html";
        }

        function openAddModal() { document.getElementById('addModal').classList.add('active'); }
        function openCreateModal() { document.getElementById('createStudentModal').classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        init();
    </script>
</body>
</html>