<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTrack Admin Panel</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; scroll-behavior: smooth; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .lang-btn.active { color: #3b82f6 !important; border-bottom: 2px solid #3b82f6; }
        .stat-card { transition: transform 0.2s; border: 1px solid #e2e8f0; }
        .stat-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .badge { padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 800; display: inline-block; }
        .badge-admin { background: #dbeafe; color: #2563eb; }
        .badge-teacher { background: #f3e8ff; color: #7c3aed; }
        .badge-student { background: #dcfce7; color: #16a34a; }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .nav-link.active { background: #2563eb !important; color: white !important; }
    </style>
</head>
<body class="flex min-h-screen">

    <aside class="w-64 bg-slate-800 text-white flex flex-col p-6 fixed h-full shadow-xl">
        <div class="text-2xl font-bold mb-10 text-blue-400 tracking-tight italic">
            <i class="fa-solid fa-graduation-cap mr-2"></i>EDUTRACK
        </div>
        <nav class="flex-1 space-y-2">
            <button onclick="showPage('dashboard', this)" class="nav-link w-full text-left p-3 rounded-xl font-medium active transition" data-i18n="nav-dash">
                <i class="fa-solid fa-gauge-high mr-2"></i> <span>Панель управления</span>
            </button>
             <button onclick="showPage('test-results', this)" class="nav-link w-full text-left p-3 hover:bg-slate-700 rounded-xl transition text-slate-300" data-i18n="nav-tests">
                <i class="fa-solid fa-vial mr-2"></i> <span>Test Results</span>
            </button>
            <button onclick="showPage('teachers', this)" class="nav-link w-full text-left p-3 hover:bg-slate-700 rounded-xl transition text-slate-300" data-i18n="nav-teachers">
                <i class="fa-solid fa-chalkboard-user mr-2"></i> <span>Учителя</span>
            </button>
            <button onclick="showPage('students', this)" class="nav-link w-full text-left p-3 hover:bg-slate-700 rounded-xl transition text-slate-300" data-i18n="nav-students">
                <i class="fa-solid fa-user-graduate mr-2"></i> <span>Ученики</span>
            </button>
            <button onclick="showPage('attendance', this)" class="nav-link w-full text-left p-3 hover:bg-slate-700 rounded-xl transition text-slate-300" data-i18n="nav-att">
                <i class="fa-solid fa-calendar-check mr-2"></i> <span>Посещаемость</span>
            </button>
        </nav>
<div class="hidden flex gap-2 justify-center mb-6 bg-white/5 p-2 rounded-xl">
    <button onclick="setLang('RU')" id="l-RU" class="lang-btn p-2 text-xs font-bold text-white/50 hover:text-white">RU</button>
    <button onclick="setLang('EN')" id="l-EN" class="lang-btn p-2 text-xs font-bold text-white/50 hover:text-white">EN</button>
    <button onclick="setLang('AZ')" id="l-AZ" class="lang-btn p-2 text-xs font-bold text-white/50 hover:text-white">AZ</button>
</div>

        <button onclick="logout()" class="p-3 text-red-400 hover:bg-slate-700 rounded-xl text-left transition">
            <i class="fa-solid fa-right-from-bracket mr-2"></i> <span data-i18n="logout">Выйти</span>
        </button>
    </aside>

    <main class="flex-1 ml-64 p-8">
        <div class="flex justify-between items-center mb-8">
            <h1 id="page-title-text" class="text-3xl font-bold text-slate-800" data-i18n="nav-dash">Панель управления</h1>
            <div class="flex gap-3">
                <button onclick="openLinkModal()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition">
                    <i class="fa-solid fa-link mr-2"></i> <span data-i18n="btn-link">Связать</span>
                </button>
                <button onclick="openModal()" class="bg-blue-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition">
                    <i class="fa-solid fa-plus mr-2"></i> <span data-i18n="btn-create">Создать</span>
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-10">
            <div class="stat-card bg-white p-5 rounded-3xl text-center border">
                <div class="text-slate-400 text-[10px] uppercase font-bold mb-2" data-i18n="stat-all">Всего</div>
                <div id="stat-all" class="text-3xl font-black text-slate-800">0</div>
            </div>
            <div class="stat-card bg-white p-5 rounded-3xl border-l-4 border-l-indigo-500 shadow-sm">
                <div class="text-slate-400 text-[10px] uppercase font-bold mb-2" data-i18n="stat-teachers">Учителя</div>
                <div id="stat-teachers" class="text-3xl font-black text-indigo-600">0</div>
            </div>
            <div class="stat-card bg-white p-5 rounded-3xl border-l-4 border-l-blue-500 shadow-sm">
                <div class="text-slate-400 text-[10px] uppercase font-bold mb-2" data-i18n="stat-students">Ученики</div>
                <div id="stat-students" class="text-3xl font-black text-blue-600">0</div>
            </div>
            <div class="stat-card bg-white p-5 rounded-3xl border-l-4 border-l-green-500 shadow-sm">
                <div class="text-slate-400 text-[10px] uppercase font-bold mb-2" data-i18n="stat-linked">Связаны</div>
                <div id="stat-linked" class="text-3xl font-black text-green-600">0</div>
            </div>
            <div class="stat-card bg-white p-5 rounded-3xl border-l-4 border-l-orange-500 shadow-sm">
                <div class="text-slate-400 text-[10px] uppercase font-bold mb-2" data-i18n="stat-unlinked">Без связи</div>
                <div id="stat-unlinked" class="text-3xl font-black text-orange-600">0</div>
            </div>
        </div>

        <div id="page-dashboard" class="page-section active space-y-8">
            <div class="bg-white rounded-3xl shadow-sm border overflow-hidden">
                <div class="p-4 bg-slate-800 text-white font-bold text-xs uppercase" data-i18n="conn-title">Active Connections</div>
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b text-[10px] uppercase text-slate-400 font-bold tracking-widest">
                        <tr><th class="p-4" data-i18n="th-teacher">Teacher</th><th class="p-4" data-i18n="th-student">Student</th><th class="p-4 text-right" data-i18n="th-action">Action</th></tr>
                    </thead>
                    <tbody id="connections-list" class="divide-y"></tbody>
                </table>
            </div>

            <div class="bg-white rounded-3xl shadow-sm border overflow-hidden">
                <div class="p-4 bg-slate-50 border-b text-slate-400 text-[10px] font-bold uppercase" data-i18n="list-all">Пользователи системы</div>
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b text-[10px] uppercase text-slate-400 font-bold tracking-widest">
                        <tr><th class="p-4" data-i18n="th-name">Имя Фамилия</th><th class="p-4">Email</th><th class="p-4" data-i18n="th-status">Статус</th><th class="p-4 text-right" data-i18n="th-action">Действие</th></tr>
                    </thead>
                    <tbody id="all-users-list" class="divide-y"></tbody>
                </table>
            </div>
        </div>

        <div id="page-attendance" class="page-section space-y-4">
            <div class="bg-white rounded-3xl shadow-sm border overflow-hidden">
                <div class="p-4 bg-emerald-600 text-white font-bold text-xs uppercase tracking-widest" data-i18n="nav-att">Журнал посещаемости</div>
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b text-[10px] uppercase text-slate-400 font-bold tracking-widest">
                        <tr>
                            <th class="p-4" data-i18n="th-teacher">Учитель</th>
                            <th class="p-4" data-i18n="th-student">Ученик</th>
                            <th class="p-4" data-i18n="th-subject">Урок</th>
                            <th class="p-4" data-i18n="th-date">Дата</th>
                            <th class="p-4" data-i18n="th-status">Статус</th>
                        </tr>
                    </thead>
                    <tbody id="admin-attendance-list" class="divide-y"></tbody>
                </table>
            </div>
        </div>

        <div id="page-test-results" class="page-section">
            <div class="bg-white rounded-3xl shadow-sm border overflow-hidden">
                <div class="p-4 bg-orange-500 text-white font-bold text-xs uppercase tracking-widest" data-i18n="nav-tests">Entrance Test Results</div>
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b text-[10px] uppercase text-slate-400 font-bold tracking-widest">
                        <tr>
                            <th class="p-4" data-i18n="th-student">Student</th>
                            <th class="p-4" data-i18n="th-score">Score</th>
                            <th class="p-4" data-i18n="th-time">Time</th>
                            <th class="p-4" data-i18n="th-date">Date</th>
                            <th class="p-4 text-right" data-i18n="th-action">Details</th>
                        </tr>
                    </thead>
                    <tbody id="test-results-list" class="divide-y"></tbody>
                </table>
            </div>
        </div>
        
        <div id="page-teachers" class="page-section">
            <div class="bg-white rounded-3xl shadow-sm border overflow-hidden">
                <div class="p-4 bg-indigo-600 text-white font-bold text-xs uppercase" data-i18n="nav-teachers">Список Учителей</div>
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b text-[10px] uppercase text-slate-400 font-bold tracking-widest">
    <tr>
        <th class="p-4" data-i18n="th-name">Имя Фамилия</th>
        <th class="p-4" data-i18n="th-subject">Предмет</th>
        <th class="p-4" data-i18n="th-students">Ученики</th>
        <th class="p-4">Demo Access</th> <th class="p-4 text-right" data-i18n="th-action">Действие</th>
    </tr>
</thead>
                    <tbody id="teacher-list" class="divide-y"></tbody>
                </table>
            </div>
        </div>

        <div id="page-students" class="page-section">
            <div class="bg-white rounded-3xl shadow-sm border overflow-hidden">
                <div class="p-4 bg-blue-600 text-white font-bold text-xs uppercase" data-i18n="nav-students">Список Учеников</div>
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 border-b text-[10px] uppercase text-slate-400 font-bold tracking-widest">
                        <tr><th class="p-4" data-i18n="th-name">Имя Фамилия</th><th class="p-4" data-i18n="th-level">Уровень</th><th class="p-4" data-i18n="th-status">Статус</th><th class="p-4 text-right" data-i18n="th-action">Действие</th></tr>
                    </thead>
                    <tbody id="student-list" class="divide-y"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="userModal" class="modal">
        <div class="bg-white p-10 rounded-[40px] shadow-2xl w-full max-w-md border-t-[10px] border-blue-600">
            <h2 class="text-2xl font-black mb-6 text-slate-800 uppercase italic">NEW USER</h2>
            <div class="space-y-4">
                <select id="reg_role" onchange="toggleRoleFields()" class="w-full p-4 bg-blue-50 border-2 border-blue-200 rounded-2xl font-bold text-blue-600 outline-none">
                    <option value="student">Student</option>
                    <option value="teacher">Teacher</option>
                    <option value="admin">Admin</option>
                </select>
                <input type="text" id="reg_name" placeholder="Name and Surname" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold outline-none">
                <input type="email" id="reg_email" placeholder="Email" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold outline-none">
                <input type="password" id="reg_pass" placeholder="Password" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold outline-none">
                <div id="student-only-fields">
                    <select id="reg_lvl" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold text-slate-500 outline-none">
                        <option value="" disabled selected>Level</option>
                        <option value="A1">A1</option><option value="A2">A2</option>
                        <option value="B1">B1</option><option value="B2">B2</option>
                        <option value="C1">C1</option><option value="C2">C2</option>
                    </select>
                </div>
                <div id="subject-field">
                    <select id="reg_subject" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold text-slate-500 outline-none">
                        <option value="" disabled selected>Subject</option>
                        <option value="English">English</option>
                        <option value="Math">Математика</option>
                        <option value="Programming">Программирование</option>
                        <option value="Art">Рисование</option>
                    </select>
                </div>
                <button onclick="createUser()" class="w-full bg-slate-900 text-white py-5 rounded-3xl font-black uppercase tracking-widest hover:bg-blue-600 transition shadow-lg">Create</button>
                <button onclick="closeModal()" class="w-full text-slate-400 font-bold mt-2">Cancel</button>
            </div>
        </div>
    </div>

    <div id="linkModal" class="modal">
        <div class="bg-white p-10 rounded-[40px] shadow-2xl w-full max-w-md border-t-[10px] border-indigo-600">
            <h2 class="text-2xl font-black mb-6 text-slate-800 uppercase italic">Связать</h2>
            <div class="space-y-4">
                <select id="link_teacher" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold text-slate-600 outline-none"></select>
                <select id="link_student" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold text-slate-600 outline-none"></select>
                <button onclick="saveLink()" class="w-full bg-indigo-600 text-white py-5 rounded-3xl font-black uppercase tracking-widest hover:bg-indigo-700 transition shadow-lg">Связать</button>
                <button onclick="closeLinkModal()" class="w-full text-slate-400 font-bold mt-2">Отмена</button>
            </div>
        </div>
    </div>

    <div id="testDetailModal" class="modal">
        <div class="bg-white rounded-[30px] max-w-2xl w-full max-h-[80vh] overflow-y-auto p-8 shadow-2xl relative">
            <button onclick="closeTestModal()" class="absolute top-4 right-6 text-slate-300 hover:text-red-500 text-3xl transition">&times;</button>
            <h3 class="text-2xl font-black text-slate-800 mb-2">Детали теста</h3>
            <p class="text-slate-400 text-xs uppercase font-bold tracking-widest mb-6">Проверка ответов ученика</p>
            <div id="test-details-content" class="space-y-4"></div>
            <button onclick="closeTestModal()" class="w-full mt-8 bg-slate-100 text-slate-600 py-4 rounded-2xl font-bold hover:bg-slate-200 transition">Закрыть</button>
        </div>
    </div>

    <script>
        const _supabase = supabase.createClient("https://jjeiytzftlmvpweaglvz.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqZWl5dHpmdGxtdnB3ZWFnbHZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0ODY5OTAsImV4cCI6MjA4NjA2Mjk5MH0.kvUjwknKvHG6Xp7xg9w7oM8kn2AaggdxxhHvTsjatJI");

        const translations = {
            RU: { 
                "nav-dash": "Панель управления", "nav-teachers": "Учителя", "nav-students": "Ученики", "nav-att": "Посещаемость", "nav-tests": "Результаты тестов", 
                "logout": "Выйти", "conn-title": "Активные связи", "list-all": "Пользователи системы", "unit-stud": "уч.",
                "stat-all": "Всего", "stat-teachers": "Учителя", "stat-students": "Ученики", "stat-linked": "Связаны", "stat-unlinked": "Без связи",
                "btn-link": "Связать", "btn-create": "Создать",
                "th-teacher": "Учитель", "th-student": "Ученик", "th-subject": "Урок", "th-date": "Дата", "th-status": "Статус", "th-action": "Действие", "th-name": "Имя Фамилия", "th-score": "Баллы", "th-time": "Время", "th-level": "Уровень", "th-students": "Ученики"
            },
            EN: { 
                "nav-dash": "Dashboard", "nav-teachers": "Teachers", "nav-students": "Students", "nav-att": "Attendance", "nav-tests": "Test Results", 
                "logout": "Logout", "conn-title": "Active Connections", "list-all": "System Users", "unit-stud": "std.",
                "stat-all": "Total", "stat-teachers": "Teachers", "stat-students": "Students", "stat-linked": "Linked", "stat-unlinked": "Unlinked",
                "btn-link": "Link", "btn-create": "Create",
                "th-teacher": "Teacher", "th-student": "Student", "th-subject": "Subject", "th-date": "Date", "th-status": "Status", "th-action": "Action", "th-name": "Full Name", "th-score": "Score", "th-time": "Time", "th-level": "Level", "th-students": "Students"
            },
            AZ: { 
                "nav-dash": "İdarə paneli", "nav-teachers": "Müəllimlər", "nav-students": "Tələbələr", "nav-att": "Davamiyyət", "nav-tests": "Test nəticələri", 
                "logout": "Çıxış", "conn-title": "Aktiv bağlantılar", "list-all": "Sistem istifadəçiləri", "unit-stud": "tələbə",
                "stat-all": "Cəmi", "stat-teachers": "Müəllimlər", "stat-students": "Tələbələr", "stat-linked": "Bağlı", "stat-unlinked": "Bağsız",
                "btn-link": "Bağla", "btn-create": "Yarat",
                "th-teacher": "Müəllim", "th-student": "Tələbə", "th-subject": "Dərs", "th-date": "Tarix", "th-status": "Status", "th-action": "Əməliyyat", "th-name": "Ad Soyad", "th-score": "Bal", "th-time": "Vaxt", "th-level": "Səviyyə", "th-students": "Tələbələr"
            }
        };

        let usersArr = [];
        let scheduleArr = [];

function showPage(pageId, navBtn) {
    // 1. Скрываем все секции (в твоем коде у них класс .page-section)
    document.querySelectorAll('.page-section').forEach(p => p.classList.remove('active'));
    
    // 2. Показываем нужную страницу (добавляем 'page-' так как у тебя такие ID в HTML)
    const target = document.getElementById('page-' + pageId);
    if (target) {
        target.classList.add('active');
    } else {
        // Если вдруг ID без приставки page-
        const altTarget = document.getElementById(pageId);
        if (altTarget) altTarget.classList.add('active');
    }

    // 3. Переключаем активную кнопку в меню
    document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
    if (navBtn) {
        navBtn.classList.add('active');
    } else {
        // Если кнопка не передана, находим её по атрибуту onclick
        const autoBtn = document.querySelector(`[onclick*="'${pageId}'"]`);
        if (autoBtn) autoBtn.classList.add('active');
    }

    // 4. САМОЕ ГЛАВНОЕ: Загрузка данных
    if (pageId === 'attendance') {
        console.log("Загружаю посещаемость...");
        loadAllAttendance(); // Вызываем новую функцию, которую мы написали
    }
    
    if (pageId === 'test-results') {
        loadTestResults();
    }
}
function showSection(id) {
    // 1. Прячем все разделы
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.add('hidden');
    });

    // 2. Показываем тот, на который нажали
    const target = document.getElementById(id);
    if (target) {
        target.classList.remove('hidden');
    }

    // 3. Если открыли посещаемость — загружаем данные
    if (id === 'attendance-section') {
        loadAllAttendance(); 
    }
    
    // 4. (Опционально) Если открыли статистику — можно обновить и её
    if (id === 'stats-section') {
        loadData();
    }
}
// Функция для переключения вкладок в админ-панели
function showSection(sectionId) {
    // 1. Находим все разделы (статистика, учителя, ученики, посещаемость)
    const sections = document.querySelectorAll('.content-section');
    
    // 2. Скрываем все разделы
    sections.forEach(s => s.classList.add('hidden'));

    // 3. Показываем тот, на который нажали
    const target = document.getElementById(sectionId);
    if (target) {
        target.classList.remove('hidden');
    }

    // 4. ЕСЛИ открыли раздел посещаемости — сразу грузим свежие данные
    if (sectionId === 'attendance-section') {
        loadAllAttendance(); 
    }
}

        async function loadData() {
            const { data: p } = await _supabase.from('profiles').select('*');
            const { data: s } = await _supabase.from('schedule').select('*');
            if (p) {
                usersArr = p;
                scheduleArr = s || [];
                updateStats();
                renderAllUsersTable(usersArr);
                renderTeachers(usersArr, scheduleArr);
                renderStudents(usersArr, scheduleArr);
                renderConnections(scheduleArr);
                setLang(localStorage.getItem('admin_lang') || 'EN');
            }
        }

async function loadAttendanceForAdmin() {
    const list = document.getElementById('admin-attendance-list');
    if (!list) return;

    list.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-slate-400">Загрузка...</td></tr>';

    try {
        const { data, error } = await _supabase
            .from('attendance')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) throw error;

        if (!data || data.length === 0) {
            list.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-slate-400">Записей пока нет</td></tr>';
            return;
        }

        list.innerHTML = data.map(row => {
            // Ищем учителя и ученика в массиве usersArr, который загружается при старте страницы
            const t = usersArr.find(u => u.id === row.teacher_id) || { full_name: 'Учитель' };
            const s = usersArr.find(u => u.id === row.student_id) || { full_name: 'Ученик' };
            
            // Настройка цветов статуса
            const colors = {
                'present': 'bg-green-100 text-green-700',
                'absent': 'bg-red-100 text-red-700',
                'late': 'bg-orange-100 text-orange-700',
                'transferred': 'bg-blue-100 text-blue-700'
            };
            const badgeClass = colors[row.status] || "bg-slate-100 text-slate-700";

            return `
            <tr class="hover:bg-slate-50 border-b transition-colors">
                <td class="p-4 font-bold text-slate-700 text-xs">${t.full_name}</td>
                <td class="p-4 text-slate-600 text-xs">${s.full_name}</td>
                <td class="p-4">
                    <span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded text-[10px] font-black uppercase">
                        ${t.subject || 'English'}
                    </span>
                </td>
                <td class="p-4 text-[10px] text-slate-400">
                    ${new Date(row.date || row.created_at).toLocaleString('ru-RU', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute:'2-digit'})}
                </td>
                <td class="p-4">
                    <div class="flex flex-col items-end gap-1">
                        <span class="${badgeClass} px-2 py-0.5 rounded font-black text-[9px] uppercase tracking-tighter">
                            ${row.status}
                        </span>
                        ${row.details ? `
                            <span class="text-[10px] font-bold text-slate-500 bg-slate-100 px-1.5 rounded border border-slate-200 shadow-sm">
                                ${row.details}
                            </span>` : ''}
                    </div>
                </td>
            </tr>`;
        }).join('');

    } catch (e) {
        list.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-red-500">${e.message}</td></tr>`;
    }
}

        async function loadTestResults() {
            const { data, error } = await _supabase.from('test_results').select('*').order('created_at', { ascending: false });
            if(error || !data) return;
            document.getElementById('test-results-list').innerHTML = data.map(r => {
                const detailsJson = r.answers_detail ? JSON.stringify(r.answers_detail).replace(/'/g, "&apos;") : "null";
                return `<tr class="border-b hover:bg-slate-50 transition text-sm">
                    <td class="p-4 font-bold text-slate-700">${r.student_name}</td>
                    <td class="p-4 font-black text-green-600">${r.score} / 10</td>
                    <td class="p-4 text-slate-500">${r.time_taken || '--:--'}</td>
                    <td class="p-4 text-xs text-slate-400">${new Date(r.created_at).toLocaleDateString()}</td>
                    <td class="p-4 text-right">
                        <button onclick='viewTestDetails(${detailsJson})' class="bg-indigo-50 text-indigo-600 px-4 py-2 rounded-xl font-bold text-xs hover:bg-indigo-600 hover:text-white transition">Детали</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function viewTestDetails(details) {
            if(!details) return;
            document.getElementById('test-details-content').innerHTML = details.map((item, i) => `
                <div class="p-4 rounded-2xl border-2 ${item.isCorrect ? 'border-green-100 bg-green-50' : 'border-red-100 bg-red-50'}">
                    <p class="font-black text-slate-800">${i+1}. ${item.question}</p>
                    <p class="text-sm mt-2">Ответ: <span class="font-bold">${item.selected}</span> ${!item.isCorrect ? `<span class="text-green-600 font-bold"> (Верно: ${item.correct})</span>` : ''}</p>
                </div>`).join('');
            document.getElementById('testDetailModal').classList.add('active');
        }

        function closeTestModal() { document.getElementById('testDetailModal').classList.remove('active'); }

        function updateStats() {
            const stds = usersArr.filter(u => u.role === 'student');
            const linkedIds = [...new Set(scheduleArr.map(s => s.student_id))];
            document.getElementById('stat-all').innerText = usersArr.length;
            document.getElementById('stat-teachers').innerText = usersArr.filter(u => u.role === 'teacher').length;
            document.getElementById('stat-students').innerText = stds.length;
            document.getElementById('stat-linked').innerText = stds.filter(s => linkedIds.includes(s.id)).length;
            document.getElementById('stat-unlinked').innerText = stds.length - stds.filter(s => linkedIds.includes(s.id)).length;
        }

        function renderAllUsersTable(users) {
            document.getElementById('all-users-list').innerHTML = users.map(u => `
                <tr class="hover:bg-slate-50 border-b text-sm">
                    <td class="p-4 font-bold">${u.full_name}</td>
                    <td class="p-4 text-slate-400">${u.username}</td>
                    <td class="p-4"><span class="badge badge-${u.role}">${u.role.toUpperCase()}</span></td>
                    <td class="p-4 text-right"><button onclick="deleteUser('${u.id}')" class="text-red-300 hover:text-red-500"><i class="fa-solid fa-trash-can"></i></button></td>
                </tr>`).join('');
        }

function renderTeachers(arr, schedule) {
    const container = document.getElementById('teacher-list');
    if (!container) return;

    container.innerHTML = arr.filter(u => u.role === 'teacher').map(u => {
        // ВАЖНО: используем can_demo (как в базе данных)
        const hasAccess = u.can_demo === true;
        
        return `
        <tr class="border-b hover:bg-slate-50 transition">
            <td class="p-4 font-bold text-slate-700">${u.full_name}</td>
            <td class="p-4 text-indigo-600 font-bold">${u.subject || '-'}</td>
            <td class="p-4 text-xs font-black text-slate-400">
                ${schedule.filter(s => s.teacher_id === u.id).length} уч.
            </td>
            <td class="p-4">
                <button onclick="toggleDemoPermission('${u.id}', ${hasAccess})" 
                        class="px-3 py-1 rounded-lg text-[10px] font-black uppercase transition-all duration-300 
                        ${hasAccess ? 'bg-green-100 text-green-600 border border-green-200 shadow-sm' : 'bg-slate-100 text-slate-400 border border-slate-200'}">
                    <i class="fa-solid ${hasAccess ? 'fa-check-circle' : 'fa-circle-xmark'} mr-1"></i>
                    ${hasAccess ? 'Demo: ON' : 'Demo: OFF'}
                </button>
            </td>
            <td class="p-4 text-right">
                <button onclick="deleteUser('${u.id}')" class="text-red-200 hover:text-red-500 transition">
                    <i class="fa-solid fa-trash-can"></i>
                </button>
            </td>
        </tr>`;
    }).join('');
}

        function renderStudents(arr, schedule) {
            document.getElementById('student-list').innerHTML = arr.filter(u => u.role === 'student').map(u => `
                <tr class="border-b">
                    <td class="p-4 font-bold">${u.full_name}</td>
                    <td class="p-4 text-xs font-black text-slate-400">${u.level || '---'}</td>
                    <td class="p-4 text-[10px] font-black uppercase">${schedule.some(s => s.student_id === u.id) ? 'connected' : 'free'}</td>
                    <td class="p-4 text-right"><button onclick="deleteUser('${u.id}')" class="text-red-300"><i class="fa-solid fa-trash-can"></i></button></td>
                </tr>`).join('');
        }

        function renderConnections(schedule) {
            document.getElementById('connections-list').innerHTML = schedule.map(item => {
                const t = usersArr.find(u => u.id === item.teacher_id);
                const s = usersArr.find(u => u.id === item.student_id);
                return `<tr class="border-b">
                    <td class="p-4 font-bold">${t?.full_name || '---'}</td>
                    <td class="p-4">${s?.full_name || '---'}</td>
                    <td class="p-4 text-right"><button onclick="unlinkPair('${item.id}')" class="text-red-400 text-xs font-bold"><i class="fa-solid fa-link-slash"></i></button></td>
                </tr>`;
            }).join('');
        }

        async function unlinkPair(id) { if(confirm("Удалить связь?")) { await _supabase.from('schedule').delete().eq('id', id); loadData(); } }
        async function deleteUser(id) { if(confirm("Удалить пользователя?")) { await _supabase.from('profiles').delete().eq('id', id); loadData(); } }
        function openModal() { document.getElementById('userModal').classList.add('active'); toggleRoleFields(); }
        function closeModal() { document.getElementById('userModal').classList.remove('active'); }
        function openLinkModal() {
            const ts = usersArr.filter(u => u.role === 'teacher');
            const ss = usersArr.filter(u => u.role === 'student');
            document.getElementById('link_teacher').innerHTML = ts.map(t => `<option value="${t.id}">${t.full_name} (${t.subject})</option>`).join('');
            document.getElementById('link_student').innerHTML = ss.map(s => `<option value="${s.id}">${s.full_name}</option>`).join('');
            document.getElementById('linkModal').classList.add('active');
        }
        function closeLinkModal() { document.getElementById('linkModal').classList.remove('active'); }
        async function saveLink() {
            const t = document.getElementById('link_teacher').value;
            const s = document.getElementById('link_student').value;
            await _supabase.from('schedule').insert([{ teacher_id: t, student_id: s }]);
            closeLinkModal(); loadData();
        }
        function toggleRoleFields() {
            const r = document.getElementById('reg_role').value;
            document.getElementById('student-only-fields').style.display = r === 'student' ? 'block' : 'none';
            document.getElementById('subject-field').style.display = r === 'admin' ? 'none' : 'block';
        }
        async function createUser() {
            const role = document.getElementById('reg_role').value;
            const name = document.getElementById('reg_name').value;
            const email = document.getElementById('reg_email').value;
            const pass = document.getElementById('reg_pass').value;
            const { data, error } = await _supabase.auth.signUp({ email, password: pass });
            if (error) return alert(error.message);
            await _supabase.from('profiles').insert([{ id: data.user.id, username: email, full_name: name, role: role, level: role === 'student' ? document.getElementById('reg_lvl').value : null, subject: role !== 'admin' ? document.getElementById('reg_subject').value : null }]);
            closeModal(); loadData();
        }
function setLang(lang) {
            localStorage.setItem('admin_lang', lang);
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('l-'+lang).classList.add('active');
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if(translations[lang][key]) {
                    const icon = el.querySelector('i');
                    if(icon) {
                        el.innerHTML = '';
                        el.appendChild(icon);
                        const span = document.createElement('span');
                        span.innerText = ' ' + translations[lang][key];
                        el.appendChild(span);
                    } else {
                        el.innerText = translations[lang][key];
                    }
                }
            });
        }

        // Делаем функцию глобальной через window, чтобы HTML её видел
// Обязательно добавляем window. чтобы кнопка увидела функцию
window.toggleDemoPermission = async function(userId, currentStatus) {
    console.log("Пытаемся изменить доступ для:", userId);

    const { error } = await _supabase
        .from('profiles')
        .update({ can_demo: !currentStatus })
        .eq('id', userId);
    
    if (error) {
        console.error("Ошибка базы данных:", error);
        alert("Ошибка: " + error.message);
    } else {
        console.log("Успешно обновлено!");
        
        // Находим учителя в локальном массиве и меняем ему статус вручную, 
        // чтобы сразу увидеть изменения без перезагрузки страницы
        if (typeof usersArr !== 'undefined') {
            const userIndex = usersArr.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                usersArr[userIndex].can_demo = !currentStatus;
                // Снова вызываем отрисовку, чтобы кнопка поменяла цвет
                renderTeachers(usersArr, scheduleArr); 
            }
        } else {
            // Если массива под рукой нет, просто обнови данные
            loadData(); 
        }
    }
}
async function loadAllAttendance() {
    const list = document.getElementById('admin-attendance-list');
    if (!list) return;

    list.innerHTML = '<tr><td colspan="5" class="text-center py-10 text-slate-400">Загрузка данных...</td></tr>';

    try {
        const { data, error } = await _supabase
            .from('attendance')
            .select('*')
            .order('created_at', { ascending: false });

        if (error) throw error;

        list.innerHTML = ''; 

        data.forEach(item => {
            const teacher = usersArr.find(u => u.id === item.teacher_id) || { full_name: 'Teacher' };
            const student = usersArr.find(u => u.id === item.student_id) || { full_name: 'Student' };

            const colors = {
                'present': 'bg-green-100 text-green-700',
                'absent': 'bg-red-100 text-red-700',
                'late': 'bg-orange-100 text-orange-700',
                'transferred': 'bg-blue-100 text-blue-700'
            };
            const badgeClass = colors[item.status] || "bg-slate-100 text-slate-700";

            const row = document.createElement('tr');
            row.className = "hover:bg-slate-50 border-b transition-colors";
            
            row.innerHTML = `
                <td class="p-4">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-chalkboard-teacher text-slate-300 text-[12px]"></i>
                        <span class="font-black text-slate-700 text-[13px] uppercase tracking-tighter">${teacher.full_name}</span>
                    </div>
                </td>
                <td class="p-4">
                    <div class="flex items-center gap-2">
                        <i class="fas fa-user-graduate text-slate-300 text-[12px]"></i>
                        <span class="font-bold text-slate-600 text-[13px]">${student.full_name}</span>
                    </div>
                </td>
                <td class="p-4">
                    <span class="bg-indigo-50 text-indigo-700 px-3 py-1 rounded text-[10px] font-black uppercase italic shadow-sm">
                        English
                    </span>
                </td>
                <td class="p-4 text-[11px] text-slate-400 font-bold text-center">
                    <i class="far fa-calendar-alt mr-1 text-slate-300"></i>
                    ${new Date(item.date || item.created_at).toLocaleString('ru-RU', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'})}
                </td>
                <td class="p-4">
                    <div class="flex flex-col items-end gap-1">
                        <span class="text-[9px] font-black text-slate-300 uppercase tracking-widest">Status</span>
                        <span class="${badgeClass} px-3 py-1 rounded font-black text-[10px] uppercase tracking-tighter shadow-sm">
                            ${item.status}
                        </span>
                        ${item.details ? `
                            <span class="text-[10px] font-black text-blue-500 bg-white border border-blue-100 px-2 py-0.5 rounded shadow-sm mt-1 flex items-center gap-1">
                                <i class="fas fa-clock text-[9px]"></i>
                                ${item.details}
                            </span>` : ''}
                    </div>
                </td>
            `;
            list.appendChild(row);
        });

    } catch (err) {
        console.error(err);
        list.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-red-500">${err.message}</td></tr>`;
    }
}

        async function logout() { 
            await _supabase.auth.signOut(); 
            window.location.href = "index.html"; 
        }

async function toggleDemoPermission(teacherId, currentStatus) {
    const { error } = await _supabase
        .from('profiles')
        .update({ can_demo: !currentStatus })
        .eq('id', teacherId);
        
    if (!error) alert("Доступ изменен!");
}

        window.onload = loadData;
// Добавьте это в самый низ скрипта admin.html
_supabase
    .channel('schema-db-changes')
    .on(
        'postgres_changes',
        {
            event: 'INSERT', // Слушаем только новые записи
            schema: 'public',
            table: 'attendance'
        },
        (payload) => {
            console.log('Новая посещаемость от учителя!', payload);
            loadAllAttendance(); // Обновляем таблицу автоматически
        }
    )
    .subscribe();
    </script>
</body>
</html>