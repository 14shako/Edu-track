<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduTrack - Student Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background-color: #f8fafc; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .tab-section.active { display: block; animation: fadeIn 0.4s ease forwards; }
        .tab-section { display: none; }

        .nav-link.active { background-color: #2563eb; color: white; box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.2); }
        
        .standard-card { 
            background: white; 
            padding: 2rem;
            border-radius: 35px;
            border: 2px solid #f1f5f9;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .standard-card:hover { 
            transform: translateY(-8px); 
            border-color: #2563eb; 
            box-shadow: 0 25px 30px -10px rgba(0, 0, 0, 0.08);
        }

        .online-status {
            position: absolute; top: 2rem; right: 2rem;
            width: 10px; height: 10px; background: #10b981;
            border-radius: 50%;
        }
        .online-status::after {
            content: ''; position: absolute; width: 100%; height: 100%;
            background: #10b981; border-radius: 50%;
            animation: pulse 2s infinite; opacity: 0.5;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.5; }
            100% { transform: scale(3); opacity: 0; }
        }

        .lang-btn.active { color: #3b82f6 !important; border-bottom: 2px solid #3b82f6; opacity: 1 !important; }
        
        aside { backdrop-filter: blur(10px); }
    </style>
</head>
<body class="flex min-h-screen">

    <aside class="w-64 bg-slate-900/95 text-white flex flex-col p-6 fixed h-full z-50 shadow-2xl">
        <div class="text-2xl font-black mb-10 text-blue-500 italic tracking-tighter flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white text-xs not-italic">ET</div>
            EDUTRACK
        </div>
        <nav class="flex-1 space-y-3">
            <button onclick="tab('hw')" id="nav-hw" class="nav-link active w-full text-left p-4 rounded-2xl font-bold transition-all">
                <i class="fa-solid fa-book-open mr-2"></i> <span data-i18n="menu-hw">Задания</span>
            </button>
            <button onclick="tab('st')" id="nav-st" class="nav-link w-full text-left p-4 rounded-2xl font-bold transition-all">
                <i class="fa-solid fa-graduation-cap mr-2"></i> <span data-i18n="menu-st">Ученики</span>
            </button>
            <button onclick="tab('tc')" id="nav-tc" class="nav-link w-full text-left p-4 rounded-2xl font-bold transition-all">
                <i class="fa-solid fa-chalkboard-user mr-2"></i> <span data-i18n="menu-tc">Учителя</span>
            </button>
            <button onclick="tab('pr')" id="nav-pr" class="nav-link w-full text-left p-4 rounded-2xl font-bold transition-all">
                <i class="fa-solid fa-circle-user mr-2"></i> <span data-i18n="menu-pr">Профиль</span>
            </button>
        </nav>

<div class="flex gap-1 justify-center mb-6 bg-white/5 p-1 rounded-xl">
    <button onclick="setLang('RU')" id="lang-RU" class="lang-btn p-2 text-[10px] font-black text-white/40 hover:text-white transition">RU</button>
    <button onclick="setLang('AZ')" id="lang-AZ" class="lang-btn p-2 text-[10px] font-black text-white/40 hover:text-white transition">AZ</button>
    <button onclick="setLang('EN')" id="lang-EN" class="lang-btn active text-blue-600 p-2 text-[10px] font-black hover:text-white transition">EN</button>
</div>

        <button onclick="logout()" class="p-3 text-red-400 font-bold mt-auto hover:bg-red-500/10 rounded-xl transition-all">
            <i class="fa-solid fa-power-off mr-2"></i> <span data-i18n="logout">Выйти</span>
        </button>
    </aside>

    <main class="flex-1 ml-64 p-10">
        <div id="sec-hw" class="tab-section active">
            <h1 class="text-4xl font-black text-slate-800 mb-10 italic uppercase tracking-tight" data-i18n="menu-hw">Задания</h1>
            <div id="hw-active-list" class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12"></div>
            <h2 class="text-xl font-bold text-slate-400 mb-6 uppercase tracking-widest border-t pt-10 flex items-center gap-4">
                <span data-i18n="archive">Архив</span>
                <div class="h-[1px] bg-slate-200 flex-1"></div>
            </h2>
            <div id="hw-done-list" class="grid grid-cols-1 md:grid-cols-2 gap-8 opacity-60"></div>
        </div>

        <div id="sec-st" class="tab-section">
            <h1 class="text-4xl font-black text-slate-800 mb-10 italic uppercase tracking-tight" data-i18n="menu-st">Ученики курса</h1>
            <div id="st-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </div>

        <div id="sec-tc" class="tab-section">
            <h1 class="text-4xl font-black text-slate-800 mb-10 italic uppercase tracking-tight" data-i18n="menu-tc">Преподаватели</h1>
            <div id="tc-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </div>

        <div id="sec-pr" class="tab-section">
            <h1 class="text-4xl font-black text-slate-800 mb-10 italic uppercase tracking-tight" data-i18n="menu-pr">Профиль</h1>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-6xl mx-auto">
                <div class="standard-card p-10">
                    <div class="flex items-center gap-6 mb-10">
                        <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-700 rounded-[25px] flex items-center justify-center text-white text-3xl font-black shadow-lg shadow-blue-200" id="prof-initials">?</div>
                        <div>
                            <p class="text-[10px] font-black text-blue-600 uppercase tracking-widest mb-1" data-i18n="role-st">Студент</p>
                            <h3 class="text-2xl font-black text-slate-800" id="display-name">---</h3>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div><label class="text-[10px] font-black text-slate-400 ml-2 uppercase" data-i18n="field-name">Имя Фамилия</label><input type="text" id="edit-name" class="w-full mt-1 p-4 bg-slate-50 rounded-2xl font-bold border-2 border-transparent focus:border-blue-600 focus:bg-white transition-all outline-none text-slate-700"></div>
                        <div><label class="text-[10px] font-black text-slate-400 ml-2 uppercase" data-i18n="field-phone">Телефон</label><div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 font-black text-slate-400">+994</span><input type="text" id="edit-phone" maxlength="9" class="w-full p-4 pl-16 bg-slate-50 rounded-2xl font-bold border-2 border-transparent focus:border-blue-600 outline-none"></div></div>
                        <div><label class="text-[10px] font-black text-slate-400 ml-2 uppercase">Zoom Link</label><input type="url" id="edit-zoom" placeholder="https://zoom.us/j/..." class="w-full mt-1 p-4 bg-slate-50 rounded-2xl font-bold border-2 border-transparent focus:border-blue-600 outline-none"></div>
                        <button onclick="saveProfile()" class="w-full bg-slate-900 text-white py-5 rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-blue-600 transition-all shadow-xl active:scale-95" data-i18n="btn-save">Обновить</button>
                    </div>
                </div>
                <div class="standard-card p-10 flex flex-col justify-between overflow-hidden">
                    <div class="relative z-10">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2" data-i18n="field-level">Мой уровень</p>
                        <div class="text-7xl font-black text-blue-600 mb-10 tracking-tighter" id="u-level">--</div>
                        <div class="bg-slate-50 p-8 rounded-[35px] border border-slate-100 relative overflow-hidden">
                            <p class="text-[10px] font-black text-slate-400 uppercase mb-4" data-i18n="field-teacher">Ваш учитель</p>
                            <div class="flex items-center gap-4"><h4 class="text-2xl font-black text-slate-800" id="u-teacher-name">---</h4></div>
                            <div class="absolute -right-4 -bottom-4 text-slate-100 text-6xl rotate-12"><i class="fa-solid fa-quote-right"></i></div>
                        </div>
                    </div>
                    <div class="mt-10 pt-8 border-t border-dashed border-slate-200">
                        <p class="text-[10px] font-black text-slate-300 uppercase mb-1">Email</p>
                        <p id="u-email" class="font-bold text-slate-400 italic">---</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const _supabase = supabase.createClient("https://jjeiytzftlmvpweaglvz.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqZWl5dHpmdGxtdnB3ZWFnbHZ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0ODY5OTAsImV4cCI6MjA4NjA2Mjk5MH0.kvUjwknKvHG6Xp7xg9w7oM8kn2AaggdxxhHvTsjatJI");
        let myId = null;
let currentLang = localStorage.getItem('lang') || 'EN';

const translations = {
    RU: {
        "menu-hw": "Задания", 
        "menu-st": "Ученики", 
        "menu-tc": "Учителя", 
        "menu-pr": "Профиль",
        "logout": "Выйти", 
        "archive": "Архив", 
        "role-st": "Студент", 
        "role-tc": "Учитель", 
        "btn-save": "Обновить",
        "field-name": "Имя Фамилия", 
        "field-phone": "Телефон", 
        "field-level": "Мой уровень", 
        "field-teacher": "Ваш учитель",
        "no-phone": "Нет номера", 
        "no-zoom": "Zoom не указан",
        "zoom-teacher": "Zoom Урока",
        "zoom-student": "Zoom Ученика",
        "empty-hw": "Заданий пока нет. Отдыхайте!"
    },
    AZ: {
        "menu-hw": "Tapşırıqlar", 
        "menu-st": "Tələbələr", 
        "menu-tc": "Müəllimlər", 
        "menu-pr": "Profil",
        "logout": "Çıxış", 
        "archive": "Arxiv", 
        "role-st": "Tələbə", 
        "role-tc": "Müəllim", 
        "btn-save": "Yadda saxla",
        "field-name": "Ad Soyad", 
        "field-phone": "Telefon", 
        "field-level": "Səviyyəm", 
        "field-teacher": "Müəlliminiz",
        "no-phone": "Nömrə yoxdur", 
        "no-zoom": "Zoom linki yoxdur",
        "zoom-teacher": "Dərs Zoom-u",
        "zoom-student": "Tələbə Zoom-u",
        "empty-hw": "Hələlik tapşırıq yoxdur. İstirahət edin!"
    },
    EN: {
        "menu-hw": "Homework", 
        "menu-st": "Students", 
        "menu-tc": "Teachers", 
        "menu-pr": "Profile",
        "logout": "Logout", 
        "archive": "Archive", 
        "role-st": "Student", 
        "role-tc": "Teacher", 
        "btn-save": "Update",
        "field-name": "Full Name", 
        "field-phone": "Phone", 
        "field-level": "My Level", 
        "field-teacher": "Your Teacher",
        "no-phone": "No phone", 
        "no-zoom": "No Zoom link",
        "zoom-teacher": "Lesson Zoom",
        "zoom-student": "Student Zoom",
        "empty-hw": "No tasks yet. Enjoy your time!"
    }
};

        async function init() {
            const { data: { session } } = await _supabase.auth.getSession();
            if (!session) { window.location.href="index.html"; return; }
            myId = session.user.id;
            _supabase.channel('updates').on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, () => loadData()).subscribe();
            await loadData();
        }

        async function loadData() {
            const { data: p } = await _supabase.from('profiles').select('*').eq('id', myId).single();
            if(p) {
                document.getElementById('display-name').innerText = p.full_name || "---";
                document.getElementById('edit-name').value = p.full_name || "";
                document.getElementById('edit-phone').value = p.phone ? p.phone.replace('+994', '') : "";
                document.getElementById('edit-zoom').value = p.zoom_link || "";
                document.getElementById('u-email').innerText = p.username || "";
                document.getElementById('u-level').innerText = p.level || "A1";
                document.getElementById('prof-initials').innerText = p.full_name ? p.full_name[0] : "?";
            }

            const { data: link } = await _supabase.from('schedule').select('teacher:teacher_id(full_name)').eq('student_id', myId).maybeSingle();
            if(link && link.teacher) document.getElementById('u-teacher-name').innerText = link.teacher.full_name;

            const { data: allUsers } = await _supabase.from('profiles').select('*');
            renderLists(allUsers);

            const { data: hws } = await _supabase.from('homework').select('*').eq('student_id', myId);
            renderHw(hws);
        }

function renderLists(users) {
    const stList = document.getElementById('st-list');
    const tcList = document.getElementById('tc-list');

    const createCard = (u, isTeacher) => {
        // 1. ОПРЕДЕЛЯЕМ ЯЗЫК внутри карточки
        const l = currentLang || localStorage.getItem('lang') || 'RU';
        
        // 2. Используем ключи для перевода кнопки
        const zoomText = isTeacher ? translations[l]['zoom-teacher'] : translations[l]['zoom-student'];
        
        const zoomBtn = u.zoom_link  
            ? `<a href="${u.zoom_link}" target="_blank" class="flex items-center justify-center gap-2 text-emerald-500 hover:text-emerald-600 font-black text-[10px] uppercase tracking-wider transition-all bg-emerald-50 py-2 px-4 rounded-xl border border-emerald-100 mb-3 w-full">
                <i class="fa-solid fa-video"></i> ${zoomText}
               </a>` 
            : `<div class="text-slate-300 font-bold text-[9px] uppercase mb-3 opacity-50 italic text-center">
                <i class="fa-solid fa-video-slash"></i> ${translations[l]['no-zoom']}
               </div>`;

        // 3. Подготовка телефона
        const displayPhone = u.phone 
            ? (u.phone.startsWith('+') ? u.phone : '+994' + u.phone) 
            : translations[l]['no-phone'];

        // 4. Бейдж
        const badge = isTeacher 
            ? `<div class="px-3 py-1 bg-blue-50 text-blue-600 rounded-xl text-[10px] font-black uppercase mb-2 border border-blue-100">${u.subject || 'Teacher'}</div>`
            : `<div class="px-3 py-1 bg-orange-50 text-orange-500 rounded-xl text-[10px] font-black uppercase mb-2 border border-orange-100">LVL: ${u.level || 'A1'}</div>`;

        // Возвращаем HTML
        return `
        <div class="standard-card group flex flex-col items-center text-center p-6">
            <div class="online-status"></div>
            <div class="w-20 h-20 bg-slate-50 rounded-[25px] mb-4 flex items-center justify-center font-black text-2xl text-slate-300 border-2 border-white ring-1 ring-slate-100 overflow-hidden shadow-inner group-hover:scale-105 transition-transform">
                ${u.avatar_url ? `<img src="${u.avatar_url}" class="w-full h-full object-cover">` : u.full_name ? u.full_name[0] : '?'}
            </div>
            
            <h4 class="font-black text-slate-800 text-lg mb-1 leading-tight line-clamp-1">${u.full_name || '...'}</h4>
            ${badge}
            
            <div class="w-full mt-2">
                ${zoomBtn}
            </div>

            <p class="text-blue-500 font-bold text-[11px] mb-6 opacity-80 flex items-center justify-center gap-1">
                <i class="fa-solid fa-phone text-[10px]"></i> ${displayPhone}
            </p>

            <div class="mt-auto w-full">
                <div class="w-full py-3 bg-slate-50 text-slate-400 rounded-2xl font-black text-[10px] text-center uppercase border border-slate-100">
                    ${isTeacher ? translations[l]['role-tc'] : translations[l]['role-st']}
                </div>
            </div>
        </div>`;
    }; // Конец createCard

    // 5. Вызов отрисовки списков
    if (stList) stList.innerHTML = users.filter(u => u.role === 'student').map(u => createCard(u, false)).join('');
    if (tcList) tcList.innerHTML = users.filter(u => u.role === 'teacher').map(u => createCard(u, true)).join('');
}

        function renderHw(hws) {
            const active = hws?.filter(h => h.status === 'active') || [];
            if(active.length === 0) {
                document.getElementById('hw-active-list').innerHTML = `
                    <div class="col-span-full py-20 text-center">
                        <i class="fa-solid fa-mug-hot text-5xl text-slate-200 mb-4"></i>
                        <p class="text-slate-400 font-bold italic">${translations[currentLang]['empty-hw']}</p>
                    </div>`;
            } else {
                document.getElementById('hw-active-list').innerHTML = active.map(h => `
                    <div class="bg-white p-8 rounded-[35px] border-l-[12px] border-blue-600 shadow-xl transition-all hover:scale-[1.02]">
                        <h3 class="font-black text-xl mb-2 text-slate-800">${h.title}</h3>
                        <p class="text-slate-500 mb-6 font-medium">${h.content}</p>
                        <button onclick="updateStatus('${h.id}', 'done')" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-blue-600 transition-all active:scale-95">Выполнено</button>
                    </div>
                `).join('');
            }
            
            document.getElementById('hw-done-list').innerHTML = hws?.filter(h => h.status === 'done').map(h => `
                <div class="bg-white p-6 rounded-[30px] border border-slate-100 opacity-70"><h3 class="font-bold text-slate-400 line-through">${h.title}</h3></div>
            `).join('') || "";
        }

        async function updateStatus(id, status) {
            await _supabase.from('homework').update({ status }).eq('id', id);
            loadData();
        }

        async function saveProfile() {
            const phoneVal = document.getElementById('edit-phone').value.replace(/\D/g, '');
            const phone = phoneVal ? "+994" + phoneVal : null;

            const { error } = await _supabase.from('profiles').update({
                full_name: document.getElementById('edit-name').value,
                phone: phone,
                zoom_link: document.getElementById('edit-zoom').value
            }).eq('id', myId);
            if(!error) { alert(currentLang === 'AZ' ? "Məlumat yeniləndi!" : "Данные обновлены!"); loadData(); }
        }

function setLang(lang) {
    currentLang = lang;
    localStorage.setItem('lang', lang);

    document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('text-blue-600', 'active'));
    document.getElementById('lang-' + lang)?.classList.add('text-blue-600', 'active');

    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (translations[lang] && translations[lang][key]) {
            if (el.tagName === 'INPUT') {
                el.placeholder = translations[lang][key];
            } else {
                el.innerText = translations[lang][key];
            }
        }
    });

    // Обязательно добавь это, чтобы списки (коллеги, учителя) 
    // тоже обновили свой текст (например, "Учитель" / "Müəllim")
    if (typeof loadData === 'function') {
        loadData();
    }
}

        function tab(n) {
            document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(b => b.classList.remove('active'));
            document.getElementById('sec-'+n).classList.add('active');
            document.getElementById('nav-'+n).classList.add('active');
        }

// Функция выхода с сохранением языка
async function logout() { 
    const currentL = localStorage.getItem('lang'); // Запоминаем текущий язык
    await _supabase.auth.signOut(); 
    localStorage.clear();
    if(currentL) localStorage.setItem('lang', currentL); // Возвращаем его обратно
    sessionStorage.clear();
    window.location.href="index.html"; 
}

// ЕДИНСТВЕННАЯ и ПРАВИЛЬНАЯ функция init
async function init() {
    // 1. Сначала применяем язык (чтобы интерфейс сразу перевелся)
    setLang(currentLang); 
    
    // 2. Проверяем авторизацию
    const { data: { session } } = await _supabase.auth.getSession();
    if (!session) { 
        window.location.href = "index.html"; 
        return; 
    }
    
    // 3. Сохраняем данные пользователя
    myId = session.user.id;
    window.tid = session.user.id; // Для совместимости
    
    // 4. Включаем авто-обновление (подписка Supabase)
    _supabase.channel('updates')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'profiles' }, () => loadData())
        .subscribe();

    // 5. Загружаем данные
    await loadData();
}

// Запускаем всё один раз
init();
    </script>
</body>
</html>